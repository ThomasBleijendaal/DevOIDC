on: 
    push:
        branches:
        - main
        - dotnet5functions

env:
  AZURE_FUNCTIONAPP_PATH: 'src/DevOidc/DevOidc.Functions'
  AZURE_FUNCTIONAPP_NAME: DevOIDC

jobs:
  build-and-deploy:
    name: Build and Deploy Function App + Static CMS
    runs-on: ubuntu-latest
    environment: production
    steps:
    - uses: actions/checkout@v1
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '5.0.100'
    - name: Build Function App
      shell: bash
      run: |
        pushd './${{ env.AZURE_FUNCTIONAPP_PATH }}'
        dotnet build --configuration Debug --output ./output
        dir -r
        popd
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    - name: Hack for next step (set runtime to None)
      uses: azure/CLI@v1
      with:
        inlineScript: |
          az webapp config appsettings set -g DevOIDC -n devoidc --settings FUNCTIONS_WORKER_RUNTIME=None
    - name: Publish Function App
      uses: Azure/functions-action@v1.3.1
      with:
        app-name: devoidc
        package: ${{ env.AZURE_FUNCTIONAPP_PATH }}/output
    - name: Update Function App (set runtime to dotnet-isolated & .net version to v5.0)
      uses: azure/CLI@v1
      with:
        inlineScript: |
          az webapp config set -g DevOIDC -n devoidc --net-framework-version v5.0 
          az webapp config appsettings set -g DevOIDC -n devoidc --settings FUNCTIONS_WORKER_RUNTIME=dotnet-isolated
    - name: Build Static CMS
      shell: bash
      run: |
        dotnet publish --configuration Release --output .\publish
        rm .\publish\wwwroot\appsettings.Development.json
        rm .\publish\wwwroot\appsettings.Development.json.br
        rm .\publish\wwwroot\appsettings.Development.json.gz
    - name: Upload Static CMS
      uses: azure/CLI@v1
      with:
        inlineScript: |
          az storage blob upload-batch -d '$web' --account-name devoidc -s ./publish/wwwroot